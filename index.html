<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>WebMidi.js Quick Start</title>
    <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <script>
      window.velocities = [];
      window.velocityMaps = [
      {
        name: 'Target velocity',
        min: 0,
        max: 127
      },  
      {
        name: 'ppp',
        min: 10,
        max: 25
      }, {
        name: 'pp',
        min: 25,
        max: 40
      }, {
        name: 'p',
        min: 40,
        max: 55
      }, {
        name: 'mp',
        min: 55,
        max: 70
      }, {
        name: 'mf',
        min: 70,
        max: 85
      }, {
        name: 'f',
        min: 85,
        max: 105
      }, {
        name: 'ff',
        min: 105,
        max: 120
      }, {
        name: 'fff',
        min: 115,
        max: 127
      }];
      window.selectedTargetVelocity = 0;
      window.errorRoundRobin = 0;
      const canvasWidth = 250;
      const canvasHeight = 450;
      function setup() {
        createCanvas(canvasWidth, canvasHeight)
        frameRate(60);
        colorMode(HSB);
        angleMode(DEGREES);
      }

      function draw() {
        background(0);
        stroke(100);
        for (let i = 0; i < window.velocities.length; i++) {
          let velocity = window.velocities[i];
          const boxSize = 250/7;
          let x = i*boxSize%canvasWidth;
          let y = floor(i*boxSize/canvasWidth)*boxSize;
          fill(map(velocity, 0, 1, 10, 100));
          rect(x, y, boxSize, boxSize);
        }
      }
    </script>
  </head>
  
  <body>
    <select id="midi-inputs"></select>
    <select id="target-velocity"></select>
    <button id="resetButton" onclick="window.velocities = []">Reset</button>
    <p id="errorMessage"></p>
  </body>

  <script type="module">
    let inputDevice;
    // populate target velocity combobox
    var targetVelocitySelect = document.getElementById("target-velocity");
    for (let i=0; i<window.velocityMaps.length; i++) { 
      const velocityMap = window.velocityMaps[i];
      var el = document.createElement("option");
      el.textContent = velocityMap.name;
      el.value = i;
      targetVelocitySelect.appendChild(el);
    }
    targetVelocitySelect.addEventListener('change', (e) => {
      window.selectedTargetVelocity = e.target.value;
    });

  // Enable WEBMIDI.js and trigger the onEnabled() function when ready
  WebMidi
    .enable()
    .then(onEnabled)
    .catch(err => alert(err));

  // Function triggered when WEBMIDI.js is ready
  function onEnabled() {
    console.log('midiEnabled');
    // add options to combobox
    var inputSelect = document.getElementById("midi-inputs");
    for (let i=0; i<WebMidi.inputs.length; i++) { 
      const input = WebMidi.inputs[i];
      var el = document.createElement("option");
      el.textContent = input.name;
      el.value = i;
      inputSelect.appendChild(el);
    }
    // callback when combobox selection changes
    inputSelect.addEventListener('change', (e) => {
      if (inputDevice) {
        inputDevice.channels[1].removeListener();
      }
      inputDevice = WebMidi.inputs[e.target.value];
      inputDevice.channels[1].addListener('noteon', e=> {
        window.velocities.push(e.velocity);
        const targetVelocity = window.velocityMaps[window.selectedTargetVelocity];
        const midiVelocity = e.velocity*127;
        let message = `${midiVelocity} (${targetVelocity.min}-${targetVelocity.max})`
        // play error sound if velocity is out of range
        if (midiVelocity < targetVelocity.min || midiVelocity > targetVelocity.max) {
          document.getElementById(`error${errorRoundRobin}`).play();
          errorRoundRobin = (errorRoundRobin+1)%4;
          message = `Out of range: ${message}`;
        }
        errorMessage.innerHTML = message;
      });
    });
    

  }



  
</script>
<audio src="error.wav" id="error0"></audio>
<audio src="error.wav" id="error1"></audio>
<audio src="error.wav" id="error2"></audio>
<audio src="error.wav" id="error3"></audio>

</html>
